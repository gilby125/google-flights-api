name: CI/CD Pipeline
on:
  push:
    branches: [ main, price-graph-sweep, develop, bulk-search-optimization ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      deploy_target:
        description: 'Deployment target'
        required: false
        default: 'none'
        type: choice
        options:
          - none
          - staging
          - production
  schedule:
    - cron: '6 0 * * 5'

env:
  GO_VERSION: '1.24'
  DOCKER_IMAGE: ghcr.io/${{ github.repository_owner }}/flight-api
  ENABLE_INTEGRATION_TESTS: ${{ vars.ENABLE_INTEGRATION_TESTS || '0' }}
  ENABLE_WORKER_TESTS: ${{ vars.ENABLE_WORKER_TESTS || '0' }}

jobs:
  build-test:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: ${{ env.GO_VERSION }}

    - name: Build
      run: go build ./...

    - name: Run tests
      run: |
        go test -p 4 -coverprofile=coverage.out ./...
        go tool cover -html=coverage.out -o coverage.html

    - name: Check for vulnerabilities
      run: |
        echo "Skipping vulnerability check for ARM builds"

  run-examples:
    runs-on: ubuntu-latest
    needs: build-test
    if: ${{ (vars.ENABLE_INTEGRATION_TESTS || '0') == '1' }}
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: ${{ env.GO_VERSION }}

    - name: Run example1
      run: go run ./examples/example1/main.go

    - name: Run example2
      run: go run ./examples/example2/main.go

    - name: Run example3
      run: go run ./examples/example3/main.go

  iata:
    runs-on: ubuntu-latest
    needs: build-test
    if: ${{ (vars.ENABLE_INTEGRATION_TESTS || '0') == '1' }}
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: ${{ env.GO_VERSION }}

    - name: Generate IATA
      run: go run ./iata/generate/generate.go

    - name: Check for changes
      run: git diff

  proto:
    runs-on: ubuntu-latest
    needs: build-test
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: ${{ env.GO_VERSION }}

    - name: Setup protocol buffer compiler
      env:
        # Protobuf releases use v21.12 tags, but the compiler reports "libprotoc 3.21.12".
        PROTOC_VERSION: 21.12
      run: |
        curl -sSL -o protoc.zip https://github.com/protocolbuffers/protobuf/releases/download/v${PROTOC_VERSION}/protoc-${PROTOC_VERSION}-linux-x86_64.zip
        unzip -o protoc.zip -d "${HOME}/.local"
        rm protoc.zip
        echo "${HOME}/.local/bin" >> "${GITHUB_PATH}"
        go install google.golang.org/protobuf/cmd/protoc-gen-go@v1.36.6
        echo "$(go env GOPATH)/bin" >> "${GITHUB_PATH}"

    - name: Generate proto
      run: go generate ./...

    - name: Check for changes
      run: |
        if [ ! -z "$(git status --porcelain)" ]
        then
          git diff
          exit 1
        fi

  docker-build:
    runs-on: ubuntu-latest
    needs: build-test
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up QEMU
      uses: docker/setup-qemu-action@v3
      with:
        platforms: linux/arm64,linux/amd64

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2

    - name: Login to GHCR
      uses: docker/login-action@v2
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Compute Docker image tags
      id: meta
      run: |
        RAW_REF="${GITHUB_REF_NAME}"
        # Docker tags must match [A-Za-z0-9_.-] and cannot include slashes.
        BRANCH="$(printf "%s" "${RAW_REF}" | tr '[:upper:]' '[:lower:]' | sed -E 's#[^a-z0-9_.-]+#-#g; s#^-+##; s#-+$##')"
        if [ -z "${BRANCH}" ]; then
          BRANCH="unknown"
        fi
        {
          echo "tags<<EOF"
          echo "${DOCKER_IMAGE}:${BRANCH}"
          echo "${DOCKER_IMAGE}:${GITHUB_SHA}"
          if [ "${BRANCH}" = "main" ]; then
            echo "${DOCKER_IMAGE}:latest"
          fi
          echo "EOF"
        } >> "${GITHUB_OUTPUT}"

    - name: Build and push Docker image (multi-arch)
      uses: docker/build-push-action@v4
      with:
        context: .
        push: ${{ github.event_name != 'pull_request' }}
        tags: ${{ steps.meta.outputs.tags }}
        platforms: linux/arm64,linux/amd64
        cache-from: type=gha
        cache-to: type=gha,mode=max
        build-args: |
          GOVULN_DISABLE=1
          CGO_ENABLED=0

  binary-build:
    runs-on: ubuntu-latest
    needs: build-test
    if: github.event_name != 'pull_request'
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: ${{ env.GO_VERSION }}

    - name: Build binaries
      run: |
        mkdir -p dist
        
        # Linux AMD64 (GCP e2-micro, Azure VMs)
        echo "Building linux/amd64..."
        CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build \
          -trimpath -ldflags="-s -w -X main.Version=${{ github.sha }}" \
          -o dist/flight-api-linux-amd64 .
        
        # Linux ARM64 (Oracle OCI Ampere, AWS Graviton)
        echo "Building linux/arm64..."
        CGO_ENABLED=0 GOOS=linux GOARCH=arm64 go build \
          -trimpath -ldflags="-s -w -X main.Version=${{ github.sha }}" \
          -o dist/flight-api-linux-arm64 .
        
        # Generate checksums
        cd dist && sha256sum * > checksums.txt

    - name: Upload binaries as artifacts
      uses: actions/upload-artifact@v4
      with:
        name: binaries-${{ github.sha }}
        path: dist/
        retention-days: 30

    - name: Create Release (main branch only)
      if: github.ref_name == 'main'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: build-${{ github.run_number }}
        name: Build ${{ github.run_number }} (${{ github.sha }})
        body: |
          Automated build from commit ${{ github.sha }}
          
          **Download binaries:**
          - `flight-api-linux-amd64` - For GCP, Azure, standard x86 VMs
          - `flight-api-linux-arm64` - For Oracle OCI Ampere, AWS Graviton
          
          **Verify checksums:**
          ```bash
          sha256sum -c checksums.txt
          ```
        files: |
          dist/flight-api-linux-amd64
          dist/flight-api-linux-arm64
          dist/checksums.txt
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  deploy-kubernetes-staging:
    runs-on: ubuntu-latest
    needs: [docker-build]
    if: ${{ github.event_name == 'push' && github.ref_name == 'main' && (vars.ENABLE_K8S_DEPLOY || '0') == '1' }}
    permissions:
      contents: read
      deployments: write
    environment: staging
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Configure Kubernetes
      uses: azure/setup-kubectl@v3
      with:
        version: '1.27.3'

    - name: Deploy to Staging
      working-directory: kubernetes/manifests/staging
      run: |
        echo "${{ secrets.KUBECONFIG_DATA }}" | base64 -d > ${HOME}/.kube/config
        kubectl apply -k .
        kubectl rollout status deployment/flight-api-staging

  performance-test:
    runs-on: ubuntu-latest
    needs: [deploy-kubernetes-staging]
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: ${{ env.GO_VERSION }}

    - name: Install hey
      run: go install github.com/rakyll/hey@latest

    - name: Run performance tests
      env:
        KUBECONFIG: ${{ secrets.KUBECONFIG_DATA }}
      run: |
        echo "Starting performance tests against staging..."
        mkdir -p $HOME/.kube
        echo "$KUBECONFIG" | base64 -d > $HOME/.kube/config
        
        STAGING_URL=$(kubectl get svc flight-api-staging -o jsonpath='{.status.loadBalancer.ingress[0].ip}')
        
        echo "Testing health endpoint:"
        hey -n 1000 -c 50 http://$STAGING_URL:8080/healthz
        
        echo "Testing search endpoint:"
        hey -n 5000 -c 100 -m POST \
          -T "application/json" \
          -D test/load/search_payload.json \
          http://$STAGING_URL:8080/api/v1/search
        
        echo "Verifying latency thresholds:"
        if ! hey -n 1000 -c 50 http://$STAGING_URL:8080/healthz | grep -q '95% in 500ms'; then
          echo "Performance threshold exceeded!"
          exit 1
        fi

  deploy-swarm:
    runs-on: ubuntu-latest
    needs: [deploy-kubernetes-staging, performance-test]
    if: github.event_name == 'push' && github.ref_name == 'main'
    steps:
    - name: Deploy to Docker Swarm
      uses: appleboy/ssh-action@v1
      with:
        host: ${{ secrets.SWARM_MANAGER }}
        username: ${{ secrets.SWARM_USER }}
        key: ${{ secrets.SWARM_SSH_KEY }}
        script: |
          # Capture current running version
          PREV_IMAGE=$(docker service inspect --format '{{.Spec.TaskTemplate.ContainerSpec.Image}}' flight-api_web)
          echo "PREV_IMAGE=${PREV_IMAGE}" >> $GITHUB_ENV
          
          # Deploy new version
          docker stack deploy \
            --with-registry-auth \
            -c docker-compose.prod.yml \
            flight-api
          
          # Verify deployment health
          MAX_RETRIES=3
          RETRY_DELAY=30
          for i in $(seq 1 $MAX_RETRIES); do
            if docker service inspect --format '{{.UpdateStatus.State}}' flight-api_web | grep -q "completed"; then
              echo "Deployment verified healthy"
              exit 0
            fi
            echo "Waiting for healthy deployment (attempt $i/$MAX_RETRIES)"
            sleep $RETRY_DELAY
          done
          
          # Rollback if verification fails
          echo "Deployment failed - rolling back to ${PREV_IMAGE}"
          docker service update \
            --image ${PREV_IMAGE} \
            --rollback-parallelism 1 \
            --update-delay 30s \
            flight-api_web
          exit 1
