<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Flight Search</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      crossorigin="anonymous"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
      rel="stylesheet"
      crossorigin="anonymous"
    />
    <style>
      body {
        background-color: #f8f9fa;
      }

      .card {
        border-radius: 0.75rem;
        box-shadow: 0 10px 30px rgba(15, 23, 42, 0.08);
      }

      .card-header {
        border-top-left-radius: 0.75rem;
        border-top-right-radius: 0.75rem;
      }

      .flight-card {
        border: 1px solid rgba(15, 23, 42, 0.1);
        border-radius: 0.75rem;
        padding: 1.25rem;
        margin-bottom: 1rem;
        background: #ffffff;
        box-shadow: 0 8px 24px rgba(15, 23, 42, 0.05);
      }

      .chart-container {
        position: relative;
        height: 320px;
      }

      .chart-container > .apex-chart {
        height: 100%;
      }

      #advancedBtn {
        font-weight: 500;
      }

      #advancedOptions {
        background: rgba(13, 110, 253, 0.04);
        border-radius: 0.75rem;
        padding: 1.5rem;
        border: 1px dashed rgba(13, 110, 253, 0.3);
      }

      #loadingIndicator {
        display: none;
        align-items: center;
        gap: 0.5rem;
      }
    </style>
  </head>
  <body>
    <div class="container py-4">
      <header class="mb-4">
        <h1 class="display-6 fw-semibold text-primary mb-2">Search Flights</h1>
        <p class="text-muted mb-0">
          Compare fares, review price history, and jump straight to Google
          Flights.
        </p>
      </header>

      <div class="card mb-4">
        <div class="card-body">
          <form id="searchForm" novalidate>
            <div class="row g-3">
              <div class="col-md-6">
                <label for="origin" class="form-label">Origin</label>
                <input
                  type="text"
                  id="origin"
                  class="form-control"
                  placeholder="e.g. JFK or MKE,MSN>FLL,MIA"
                  required
                />
              </div>
              <div class="col-md-6">
                <label for="destination" class="form-label">Destination</label>
                <input
                  type="text"
                  id="destination"
                  class="form-control"
                  placeholder="e.g. LAX or FLL,MIA"
                  required
                />
              </div>
              <div class="col-md-4">
                <label for="departure_date" class="form-label"
                  >Departure Date</label
                >
                <input
                  type="date"
                  id="departure_date"
                  class="form-control"
                  placeholder="Select date"
                  required
                />
              </div>
              <div class="col-md-4">
                <label for="return_date" class="form-label">Return Date</label>
                <input
                  type="date"
                  id="return_date"
                  class="form-control"
                  placeholder="Select date (optional)"
                />
              </div>
              <div class="col-md-4">
                <label for="trip_type" class="form-label">Trip Type</label>
                <select id="trip_type" class="form-select">
                  <option value="round_trip" selected>Round trip</option>
                  <option value="one_way">One way</option>
                </select>
              </div>
            </div>

            <div class="d-flex flex-wrap align-items-center gap-3 mt-3">
              <button
                type="button"
                class="btn btn-link text-decoration-none px-0"
                id="advancedBtn"
              >
                <i class="bi bi-sliders me-2"></i>Advanced options
              </button>
              <div class="text-muted small">
                Adjust cabin class, stops, passengers, and currency.
              </div>
            </div>

            <div
              id="advancedOptions"
              class="row g-3 mt-1"
              style="display: none"
            >
              <div class="col-md-3">
                <label for="class" class="form-label">Cabin Class</label>
                <select id="class" class="form-select">
                  <option value="economy" selected>Economy</option>
                  <option value="premium_economy">Premium Economy</option>
                  <option value="business">Business</option>
                  <option value="first">First</option>
                </select>
              </div>
              <div class="col-md-3">
                <label for="stops" class="form-label">Stops</label>
                <select id="stops" class="form-select">
                  <option value="any" selected>Any</option>
                  <option value="non_stop">Non-stop</option>
                  <option value="1">1 stop</option>
                  <option value="2">2+ stops</option>
                </select>
              </div>
              <div class="col-md-2">
                <label for="adults" class="form-label">Adults</label>
                <input
                  type="number"
                  id="adults"
                  class="form-control"
                  value="1"
                  min="1"
                  required
                />
              </div>
              <div class="col-md-2">
                <label for="children" class="form-label">Children</label>
                <input
                  type="number"
                  id="children"
                  class="form-control"
                  value="0"
                  min="0"
                />
              </div>
              <div class="col-md-2">
                <label for="infantsLap" class="form-label">Infants (lap)</label>
                <input
                  type="number"
                  id="infantsLap"
                  class="form-control"
                  value="0"
                  min="0"
                />
              </div>
              <div class="col-md-2">
                <label for="infantsSeat" class="form-label"
                  >Infants (seat)</label
                >
                <input
                  type="number"
                  id="infantsSeat"
                  class="form-control"
                  value="0"
                  min="0"
                />
              </div>
              <div class="col-md-2">
                <label for="currency" class="form-label">Currency</label>
                <input
                  type="text"
                  id="currency"
                  class="form-control text-uppercase"
                  value="USD"
                  maxlength="3"
                />
              </div>

              <div class="col-12">
                <div class="form-check">
                  <input
                    class="form-check-input"
                    type="checkbox"
                    id="includePriceGraph"
                  />
                  <label class="form-check-label" for="includePriceGraph">
                    Show Google price graph (flexible dates)
                  </label>
                  <div class="text-muted small">
                    Fetches the calendar-style price graph Google shows for a
                    date range (may be slower than a normal search).
                  </div>
                </div>
              </div>

              <div class="col-12">
                <div class="form-check">
                  <input
                    class="form-check-input"
                    type="checkbox"
                    id="debugBatches"
                  />
                  <label class="form-check-label" for="debugBatches">
                    Debug multi-route batches
                  </label>
                  <div class="text-muted small">
                    Adds diagnostics to explain missing origin→destination pairs
                    (slightly larger responses).
                  </div>
                </div>
              </div>

              <div class="col-12">
                <div class="form-check">
                  <input
                    class="form-check-input"
                    type="checkbox"
                    id="excludeLowCost"
                  />
                  <label class="form-check-label" for="excludeLowCost">
                    Exclude low-cost carriers
                  </label>
                  <div class="text-muted small">
                    Best-effort (based on airline code group tagging).
                  </div>
                </div>
              </div>

              <div class="col-12">
                <div class="text-muted small mb-2">Only show alliances</div>
                <div class="d-flex flex-wrap gap-3">
                  <div class="form-check">
                    <input
                      class="form-check-input"
                      type="checkbox"
                      id="includeStar"
                    />
                    <label class="form-check-label" for="includeStar"
                      >Star Alliance</label
                    >
                  </div>
                  <div class="form-check">
                    <input
                      class="form-check-input"
                      type="checkbox"
                      id="includeOneworld"
                    />
                    <label class="form-check-label" for="includeOneworld"
                      >oneworld</label
                    >
                  </div>
                  <div class="form-check">
                    <input
                      class="form-check-input"
                      type="checkbox"
                      id="includeSkyTeam"
                    />
                    <label class="form-check-label" for="includeSkyTeam"
                      >SkyTeam</label
                    >
                  </div>
                </div>
                <div class="text-muted small mt-1">
                  If any are checked, results must match at least one selected
                  alliance.
                </div>
                <div class="text-muted small mt-1">
                  Tip: if exactly one alliance is selected (and no excludes),
                  we’ll also apply it to Google (including the price graph).
                </div>
              </div>

              <div class="col-12">
                <div class="text-muted small mb-2">
                  Restrict Google results (advanced)
                </div>
                <div class="row g-2">
                  <div class="col-12">
                    <label for="googleCarriers" class="form-label"
                      >Google airlines (IATA codes)</label
                    >
                    <input
                      type="text"
                      id="googleCarriers"
                      class="form-control"
                      placeholder="e.g. UA,DL,B6"
                    />
                    <div class="text-muted small">
                      Optional. If set, overrides the alliance checkboxes above
                      for the Google query (offers + price graph).
                    </div>
                  </div>
                </div>
              </div>

              <div class="col-md-4 priceGraphOption" style="display: none">
                <label for="priceGraphMode" class="form-label"
                  >Price graph mode</label
                >
                <select id="priceGraphMode" class="form-select">
                  <option value="around_date" selected>
                    Around selected departure date
                  </option>
                  <option value="open_dates">
                    Open dates (range starting at departure date)
                  </option>
                </select>
              </div>

              <div class="col-md-4 priceGraphOption" style="display: none">
                <label for="priceGraphWindowDays" class="form-label"
                  >Price graph window (days)</label
                >
                <input
                  type="number"
                  id="priceGraphWindowDays"
                  class="form-control"
                  value="30"
                  min="2"
                  max="161"
                />
              </div>

              <div
                class="col-md-4 priceGraphOptionOpen"
                style="display: none"
              >
                <label for="priceGraphTripLengthDays" class="form-label"
                  >Trip length (days)</label
                >
                <input
                  type="number"
                  id="priceGraphTripLengthDays"
                  class="form-control"
                  value="7"
                  min="0"
                  max="30"
                />
                <div class="text-muted small">
                  Used when return date is not specified (round trips).
                </div>
              </div>
            </div>

            <div class="d-flex flex-wrap align-items-center gap-3 mt-4">
              <button type="submit" class="btn btn-primary px-4">
                <i class="bi bi-search me-2"></i>Search Flights
              </button>
              <button
                type="button"
                class="btn btn-outline-secondary px-4"
                id="recurringBtn"
              >
                <i class="bi bi-calendar2-event me-2"></i>Recurring
              </button>
              <div id="loadingIndicator" class="loading-indicator text-muted">
                <div
                  class="spinner-border spinner-border-sm me-2"
                  role="status"
                  aria-hidden="true"
                ></div>
                <span id="loadingIndicatorText">Searching fares…</span>
                <span id="loadingIndicatorMeta" class="ms-2 small"></span>
              </div>
            </div>

            <div id="recurringOptions" class="mt-4" style="display: none">
              <div class="border rounded-3 p-3 bg-white">
                <div
                  class="d-flex flex-wrap align-items-center justify-content-between gap-2"
                >
                  <div>
                    <div class="fw-semibold">Recurring searches</div>
                    <div class="text-muted small">
                      Create scheduled searches for the entered
                      origin/destination set.
                    </div>
                  </div>
                </div>

                <div class="row g-3 mt-2">
                  <div class="col-md-6">
                    <label for="recurringName" class="form-label">Name</label>
                    <input
                      type="text"
                      id="recurringName"
                      class="form-control"
                      placeholder="Optional (e.g. Florida weekend watch)"
                    />
                  </div>
                  <div class="col-md-3">
                    <label for="recurringInterval" class="form-label"
                      >Interval</label
                    >
                    <select id="recurringInterval" class="form-select">
                      <option value="daily" selected>Daily</option>
                      <option value="weekly">Weekly (Mon)</option>
                      <option value="monthly">Monthly (1st)</option>
                    </select>
                  </div>
                  <div class="col-md-3">
                    <label for="recurringTime" class="form-label">Time</label>
                    <input
                      type="time"
                      id="recurringTime"
                      class="form-control"
                      value="07:00"
                    />
                  </div>

                  <div class="col-12">
                    <div class="form-check">
                      <input
                        class="form-check-input"
                        type="checkbox"
                        id="recurringDynamicDates"
                        checked
                      />
                      <label
                        class="form-check-label"
                        for="recurringDynamicDates"
                      >
                        Use dynamic dates (relative to execution time)
                      </label>
                      <div class="text-muted small">
                        Example: “search 14 days from now across a 7-day
                        window”.
                      </div>
                    </div>
                  </div>

                  <div class="col-md-4 recurringDynamicField">
                    <label for="recurringDaysFromExecution" class="form-label"
                      >Days from execution</label
                    >
                    <input
                      type="number"
                      id="recurringDaysFromExecution"
                      class="form-control"
                      value="14"
                      min="0"
                    />
                  </div>
                  <div class="col-md-4 recurringDynamicField">
                    <label for="recurringSearchWindowDays" class="form-label"
                      >Search window (days)</label
                    >
                    <input
                      type="number"
                      id="recurringSearchWindowDays"
                      class="form-control"
                      value="7"
                      min="1"
                    />
                  </div>
                  <div class="col-md-4 recurringDynamicField">
                    <label for="recurringTripLength" class="form-label"
                      >Trip length (nights)</label
                    >
                    <input
                      type="number"
                      id="recurringTripLength"
                      class="form-control"
                      value="7"
                      min="0"
                    />
                    <div class="text-muted small">Used for round trips.</div>
                  </div>

                  <div class="col-12 d-flex flex-wrap align-items-center gap-2">
                    <button
                      type="button"
                      class="btn btn-success"
                      id="createRecurringBtn"
                    >
                      <i class="bi bi-plus-circle me-2"></i>Create recurring
                      search
                    </button>
                    <div class="text-muted small" id="recurringStatus"></div>
                  </div>
                </div>
              </div>
            </div>
          </form>
        </div>
      </div>

      <div class="card mb-4" id="priceGraphCard" style="display: none">
        <div class="card-header bg-light">
          <i class="bi bi-graph-up-arrow me-2 text-primary"></i>
          Price History
        </div>
        <div class="card-body">
          <div id="priceHistoryEmpty" class="alert alert-info d-none" role="alert">
            No price history collected for this route yet.
          </div>
          <div class="chart-container">
            <div
              id="priceGraph"
              class="apex-chart"
              role="img"
              aria-label="Flight price history"
            ></div>
          </div>
        </div>
      </div>

      <div class="card mb-4" id="googlePriceGraphCard" style="display: none">
        <div class="card-header bg-light">
          <i class="bi bi-graph-up me-2 text-primary"></i>
          Google Price Graph
        </div>
        <div class="card-body">
          <div
            id="googlePriceGraphError"
            class="alert alert-warning d-none"
            role="alert"
          ></div>
          <div class="chart-container">
            <div
              id="googlePriceGraph"
              class="apex-chart"
              role="img"
              aria-label="Google price graph"
            ></div>
          </div>
          <div class="text-muted small mt-2">
            Tip: click a point to open it in Google Flights.
          </div>
        </div>
      </div>

      <div class="card" id="resultsCard" style="display: none">
        <div
          class="card-header bg-white d-flex flex-wrap justify-content-between align-items-center gap-3"
        >
          <div>
            <h2 class="h5 mb-0">Flight Results</h2>
            <p class="text-muted mb-0 small">
              We’ll sort the best fares for you—choose another ordering if you
              prefer.
            </p>
          </div>
          <div class="d-flex align-items-center gap-2">
            <label for="sortResults" class="form-label mb-0 text-muted small"
              >Sort by</label
            >
            <select id="sortResults" class="form-select form-select-sm">
              <option value="price">Lowest price</option>
              <option value="duration">Shortest duration</option>
              <option value="departure">Earliest departure</option>
            </select>
          </div>
        </div>
        <div class="card-body">
	          <div id="asyncBulkStatus" class="mb-3 d-none">
	            <div class="d-flex justify-content-between align-items-baseline">
	              <div id="asyncBulkStatusText" class="text-muted small"></div>
	              <div id="asyncBulkStatusCounts" class="text-muted small"></div>
	            </div>
	            <div class="small mt-1">
	              <a id="asyncBulkResumeLink" class="link-primary d-none" href="#"
	                >Resume this bulk search</a
	              >
	              <span id="asyncBulkLinksSep" class="text-muted d-none"> • </span>
	              <a id="asyncBulkOpenResultsLink" class="link-primary d-none" href="#"
	                >Open results page</a
	              >
	            </div>
	            <div id="asyncBulkStatusMeta" class="text-muted small mt-1"></div>
	            <div id="asyncBulkActions" class="mt-2 d-none">
	              <div class="d-flex flex-wrap gap-2">
	                <button
	                  type="button"
                  class="btn btn-outline-secondary btn-sm"
                  id="asyncBulkCheckWorkersBtn"
                >
                  Check workers
                </button>
                <button
                  type="button"
                  class="btn btn-outline-secondary btn-sm"
                  id="asyncBulkCheckQueueBtn"
                >
                  Check queue
                </button>
                <button
                  type="button"
                  class="btn btn-outline-warning btn-sm"
                  id="asyncBulkPauseContinuousBtn"
                >
                  Pause continuous sweep
                </button>
                <button
                  type="button"
                  class="btn btn-outline-danger btn-sm"
                  id="asyncBulkStopContinuousBtn"
                >
                  Stop continuous sweep
                </button>
                <button
                  type="button"
                  class="btn btn-outline-danger btn-sm"
                  id="asyncBulkClearContinuousPendingBtn"
                >
                  Clear continuous pending
                </button>
                <button
                  type="button"
                  class="btn btn-outline-danger btn-sm"
                  id="asyncBulkClearContinuousProcessingBtn"
                >
                  Clear continuous processing
                </button>
              </div>
              <div id="asyncBulkDiag" class="text-muted small mt-2"></div>
            </div>
            <div class="progress mt-2" style="height: 0.75rem">
              <div
                id="asyncBulkProgressBar"
                class="progress-bar"
                role="progressbar"
                style="width: 0%"
                aria-valuemin="0"
                aria-valuemax="100"
                aria-valuenow="0"
              ></div>
            </div>
          </div>
          <div id="flightResults"></div>
        </div>
      </div>
    </div>

    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/apexcharts@3.49.1"
      crossorigin="anonymous"
    ></script>
    <script src="/search.js?v=20260127-19"></script>
  </body>
</html>
